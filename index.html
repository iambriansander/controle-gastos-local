<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Controle de Gastos</title>
  <meta name="description" content="Controle simples de entradas, saídas, itens e importação de extratos (CSV/OFX) com PWA."/>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f766e" />
  <link rel="icon" href="icons/icon-192.png" type="image/png"/>

  <style>
    :root {
      --bg: #0b1215;
      --card: #0f1720;
      --muted: #94a3b8;
      --border: #1f2937;
      --primary: #0ea5a0;
      --primary-2: #14b8a6;
      --text: #e5e7eb;
      --danger: #ef4444;
      --ok: #22c55e;
      --warn: #f59e0b;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background: linear-gradient(135deg, #071018, #091721);
      color: var(--text); font-family: Inter, system-ui, Arial, sans-serif;
    }
    header {
      padding: 20px 16px; position: sticky; top: 0; z-index: 10;
      background: rgba(7,16,24,0.7); backdrop-filter: blur(6px); border-bottom: 1px solid var(--border);
    }
    .container { max-width: 1100px; margin: 0 auto; padding: 0 12px; }
    h1 { margin: 0; font-size: 22px; font-weight: 600; }
    .sub { color: var(--muted); font-size: 13px; margin-top: 4px; }

    .tabs {
      display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px;
    }
    .tab-btn {
      background: #0b1220; color: var(--text); border: 1px solid var(--border);
      padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 14px;
    }
    .tab-btn.active {
      background: linear-gradient(135deg, #0b2a2a, #0a3734);
      border-color: #145a56;
    }

    main { padding: 16px 0 40px; }
    .card {
      background: linear-gradient(180deg, #0c121a, #0b141a);
      border: 1px solid var(--border);
      border-radius: 12px; padding: 16px; margin-bottom: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .row.wrap { flex-wrap: wrap; }
    .align-end { align-items: end; }
    .mt8 { margin-top: 8px; }
    .mt12 { margin-top: 12px; }
    .mt16 { margin-top: 16px; }
    .mt20 { margin-top: 20px; }
    .muted { color: var(--muted); font-size: 12px; }
    .grid { display: grid; gap: 12px; }
    .grid-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .grid-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .grid-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
    @media (max-width: 900px) {
      .grid-4 { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 600px) {
      .grid-3, .grid-4, .grid-2 { grid-template-columns: 1fr; }
    }
    label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px; }
    input, select, textarea {
      width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border);
      background: #0b1220; color: var(--text); font-size: 14px;
    }
    textarea { min-height: 80px; }
    .btn {
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      border: none; color: #062a2a; font-weight: 700; letter-spacing: .2px;
      padding: 10px 12px; border-radius: 8px; cursor: pointer;
    }
    .btn.alt { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .btn.danger { background: linear-gradient(135deg, #c0392b, #ef4444); color: white; }

    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { border-bottom: 1px solid var(--border); padding: 10px 8px; text-align: left; }
    th { color: var(--muted); font-weight: 500; }
    tbody tr:hover { background: rgba(255,255,255,0.02); }

    .pill { font-size: 12px; padding: 3px 8px; border-radius: 999px; border: 1px solid var(--border); color: var(--muted); }
    .pill.ok { color: #10b981; border-color: #0f5132; background: rgba(16,185,129,0.08); }
    .pill.warn { color: #f59e0b; border-color: #7c5d0b; background: rgba(245,158,11,0.08); }
    .pill.bad { color: #ef4444; border-color: #7c1f0b; background: rgba(239,68,68,0.08); }

    .kpi { display: grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 12px; }
    .kpi .card { padding: 14px; }
    .kpi h3 { margin: 0 0 6px; font-size: 13px; color: var(--muted); font-weight: 500; }
    .kpi .val { font-size: 20px; font-weight: 700; }

    .preview { max-height: 300px; overflow: auto; border: 1px solid var(--border); border-radius: 8px; }
    .tag { padding: 2px 6px; border-radius: 6px; border: 1px solid var(--border); font-size: 12px; color: var(--muted); }

    .footer { text-align: center; color: var(--muted); font-size: 12px; margin-top: 20px; }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Controle de Gastos</h1>
      <div class="sub">Entradas, Saídas, Itens, Importação de extratos (Inter/Nubank/Mercado Pago) e PWA</div>
      <div class="tabs mt12">
        <button class="tab-btn active" data-tab="dashboard">Dashboard</button>
        <button class="tab-btn" data-tab="entradas">Entradas</button>
        <button class="tab-btn" data-tab="saidas">Saídas</button>
        <button class="tab-btn" data-tab="itens">Itens</button>
        <button class="tab-btn" data-tab="transferencias">Transferências</button>
        <button class="tab-btn" data-tab="orcamento">Orçamento</button>
        <button class="tab-btn" data-tab="importacao">Importação</button>
        <button class="tab-btn" data-tab="config">Configurações</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- DASHBOARD -->
    <section id="dashboard" class="tab">
      <div class="kpi">
        <div class="card">
          <h3>Entradas (mês)</h3>
          <div class="val" id="kpiIn">R$ 0,00</div>
        </div>
        <div class="card">
          <h3>Saídas (mês)</h3>
          <div class="val" id="kpiOut">R$ 0,00</div>
        </div>
        <div class="card">
          <h3>Saldo (mês)</h3>
          <div class="val" id="kpiBal">R$ 0,00</div>
        </div>
        <div class="card">
          <h3>Itens comprados (mês)</h3>
          <div class="val" id="kpiItems">0</div>
        </div>
      </div>

      <div class="card mt16">
        <div class="row wrap">
          <div><label>Mês/Ano</label><input type="month" id="dashMonth"></div>
          <div><label>Conta</label><select id="dashAccount"></select></div>
          <div class="row align-end"><button class="btn" onclick="refreshDashboard()">Atualizar</button></div>
        </div>
        <div class="mt12">
          <span class="pill ok">Entradas</span>
          <span class="pill bad">Saídas</span>
          <span class="pill warn">Orçamento</span>
        </div>
        <div class="mt12">
          <div id="reportCat"></div>
        </div>
      </div>
    </section>

    <!-- ENTRADAS -->
    <section id="entradas" class="tab card" style="display:none">
      <h3>Entradas</h3>
      <div class="row wrap">
        <div><label>Data</label><input type="date" id="inDate"></div>
        <div><label>Descrição</label><input id="inDesc" placeholder="ex.: Salário"></div>
        <div><label>Valor</label><input id="inVal" type="number" step="0.01" placeholder="0,00"></div>
        <div><label>Conta</label><select id="inAcc"></select></div>
        <div><label>Categoria</label><select id="inCat"></select></div>
        <div><label>Loja</label><input id="inStore" placeholder="opcional"></div>
        <div class="row align-end"><button class="btn" onclick="addEntrada()">Adicionar</button></div>
      </div>
      <div class="mt12"><table id="tblIn"><thead><tr><th>Data</th><th>Descrição</th><th>Valor</th><th>Conta</th><th>Categoria</th><th>Loja</th><th></th></tr></thead><tbody></tbody></table></div>
    </section>

    <!-- SAÍDAS -->
    <section id="saidas" class="tab card" style="display:none">
      <h3>Saídas</h3>
      <div class="row wrap">
        <div><label>Data</label><input type="date" id="outDate"></div>
        <div><label>Descrição</label><input id="outDesc" placeholder="ex.: Mercado, Aluguel"></div>
        <div><label>Valor</label><input id="outVal" type="number" step="0.01" placeholder="0,00"></div>
        <div><label>Conta</label><select id="outAcc"></select></div>
        <div><label>Categoria</label><select id="outCat"></select></div>
        <div><label>Loja</label><input id="outStore" placeholder="opcional"></div>
        <div class="row align-end"><button class="btn" onclick="addSaida()">Adicionar</button></div>
      </div>
      <div class="mt12"><table id="tblOut"><thead><tr><th>Data</th><th>Descrição</th><th>Valor</th><th>Conta</th><th>Categoria</th><th>Loja</th><th></th></tr></thead><tbody></tbody></table></div>
    </section>

    <!-- ITENS -->
    <section id="itens" class="tab card" style="display:none">
      <h3>Itens comprados</h3>
      <div class="row wrap">
        <div><label>Data</label><input type="date" id="itemDate"></div>
        <div><label>Descrição</label><input id="itemDesc" placeholder="ex.: Arroz 5kg"></div>
        <div><label>Quantidade</label><input id="itemQty" type="number" step="1" value="1"></div>
        <div><label>Preço unitário</label><input id="itemPrice" type="number" step="0.01"></div>
        <div><label>Categoria</label><select id="itemCat"></select></div>
        <div><label>Loja</label><input id="itemStore" placeholder="ex.: Mercado X"></div>
        <div class="row align-end"><button class="btn" onclick="addItem()">Adicionar</button></div>
      </div>
      <div class="mt12"><table id="tblItems"><thead><tr><th>Data</th><th>Descrição</th><th>Qtd</th><th>Preço</th><th>Total</th><th>Categoria</th><th>Loja</th><th></th></tr></thead><tbody></tbody></table></div>
    </section>

    <!-- TRANSFERÊNCIAS -->
    <section id="transferencias" class="tab card" style="display:none">
      <h3>Transferências</h3>
      <div class="row wrap">
        <div><label>Data</label><input type="date" id="trDate"></div>
        <div><label>Descrição</label><input id="trDesc" placeholder="opcional"></div>
        <div><label>Valor</label><input id="trVal" type="number" step="0.01"></div>
        <div><label>De</label><select id="trFrom"></select></div>
        <div><label>Para</label><select id="trTo"></select></div>
        <div class="row align-end"><button class="btn" onclick="addTransfer()">Transferir</button></div>
      </div>
      <div class="mt12"><table id="tblTr"><thead><tr><th>Data</th><th>Descrição</th><th>Valor</th><th>De</th><th>Para</th><th></th></tr></thead><tbody></tbody></table></div>
    </section>

    <!-- ORÇAMENTO -->
    <section id="orcamento" class="tab card" style="display:none">
      <h3>Orçamento mensal por categoria</h3>
      <div class="grid grid-3">
        <div>
          <label>Categoria</label>
          <select id="budCat"></select>
        </div>
        <div>
          <label>Valor mensal</label>
          <input id="budVal" type="number" step="0.01">
        </div>
        <div class="row align-end">
          <button class="btn" onclick="addBudget()">Adicionar</button>
        </div>
      </div>
      <div class="mt12">
        <table id="tblBudget"><thead><tr><th>Categoria</th><th>Valor</th><th></th></tr></thead><tbody></tbody></table>
      </div>
    </section>

    <!-- IMPORTAÇÃO -->
    <section id="importacao" class="tab card" style="display:none">
      <h3>Importação de Extratos (CSV/OFX)</h3>
      <div class="grid grid-4">
        <div>
          <label>Conta</label>
          <select id="impConta"></select>
        </div>
        <div>
          <label>Banco/Origem</label>
          <select id="impOrigem">
            <option value="auto">Detectar automaticamente</option>
            <option value="inter">Banco Inter</option>
            <option value="nubank">Nubank</option>
            <option value="mercadopago">Mercado Pago</option>
            <option value="gen">Genérico</option>
          </select>
        </div>
        <div>
          <label>Separador CSV</label>
          <select id="impSep">
            <option value=",">Vírgula (,)</option>
            <option value=";">Ponto e vírgula (;)</option>
            <option value="tab">Tab</option>
          </select>
        </div>
        <div>
          <label>Codificação</label>
          <select id="impEnc">
            <option value="UTF-8">UTF-8</option>
            <option value="ISO-8859-1">ISO-8859-1</option>
          </select>
        </div>
      </div>

      <div class="row mt12">
        <input type="file" id="impFile" accept=".csv,.ofx,.txt" />
        <button class="btn" onclick="handleImport()">Processar arquivo</button>
      </div>

      <h4 class="mt16">Mapeamento de colunas (CSV)</h4>
      <div class="grid grid-4">
        <div>
          <label>Data</label>
          <select id="mapDate"></select>
        </div>
        <div>
          <label>Descrição</label>
          <select id="mapDesc"></select>
        </div>
        <div>
          <label>Valor</label>
          <select id="mapVal"></select>
        </div>
        <div>
          <label>Tipo (C/D)</label>
          <select id="mapType"><option value="">—</option></select>
        </div>
      </div>
      <div class="row mt12">
        <button class="btn alt" onclick="applyMapping()">Aplicar mapeamento</button>
      </div>

      <h4 class="mt16">Pré-visualização</h4>
      <div class="preview" id="previewBox"></div>
      <div class="row mt12">
        <button class="btn" onclick="confirmImport()">Importar lançamentos</button>
      </div>

      <h4 class="mt16">Regras de categorização</h4>
      <div class="rules">
        <div class="grid grid-4">
          <div>
            <label>Se descrição contiver</label>
            <input id="ruleText" placeholder="ex.: UBER, IFood, Netflix" />
          </div>
          <div>
            <label>Categoria</label>
            <select id="ruleCategory"></select>
          </div>
          <div>
            <label>Loja (opcional)</label>
            <input id="ruleStore" placeholder="ex.: Uber, IFood, Netflix" />
          </div>
          <div class="row align-end">
            <button class="btn" onclick="addRule()">Adicionar regra</button>
          </div>
        </div>
        <div id="rulesList" class="mt8"></div>
      </div>
    </section>

    <!-- CONFIGURAÇÕES -->
    <section id="config" class="tab card" style="display:none">
      <h3>Configurações</h3>
      <div class="grid grid-3">
        <div>
          <label>Contas</label>
          <textarea id="cfgAccounts" placeholder="Uma por linha, ex.: Nubank; Banco Inter; Mercado Pago"></textarea>
        </div>
        <div>
          <label>Lojas favoritas (sugestões)</label>
          <textarea id="cfgStores" placeholder="Ex.: Mercado X; Uber; iFood"></textarea>
        </div>
        <div>
          <label>Backup/Restore (JSON)</label>
          <div class="row">
            <button class="btn" onclick="downloadBackup()">Baixar backup</button>
            <input type="file" id="restoreFile" accept="application/json" />
            <button class="btn alt" onclick="restoreBackup()">Restaurar</button>
          </div>
        </div>
      </div>
      <div class="mt12">
        <button class="btn" onclick="saveConfig()">Salvar configurações</button>
      </div>
      <div class="mt12 muted">Os dados ficam no seu navegador (Local Storage). Ative o PWA para usar offline.</div>
    </section>

    <div class="footer">PWA habilitado. Para instalar no celular, use “Adicionar à tela inicial”.</div>
  </main>

  <script>
    // ==========================
    // Categorias oficiais + aliases
    // ==========================
    const CATEGORIES = [
      "Moradia",
      "Contas e serviços",
      "Amizades e família",
      "Roupas",
      "Doações",
      "Supermercado",
      "Entretenimento",
      "Compras",
      "Serviços profissionais",
      "Comida e bebida",
      "Transporte",
      "Saúde e cuidados pessoais"
    ];

    const CATEGORY_ALIASES = {
      "Moradia": ["Aluguel", "Condomínio", "IPTU", "Habitação", "Aluguel/Moradia"],
      "Contas e serviços": ["Contas", "Utilidades", "Luz", "Água", "Gás", "Internet", "Telefonia", "Energia"],
      "Amizades e família": ["Família", "Presentes", "Crianças", "Pais", "Amigos", "Parentes"],
      "Roupas": ["Vestuário", "Moda", "Calçados"],
      "Doações": ["Caridade", "ONG", "Contribuições"],
      "Supermercado": ["Mercado", "Hipermercado", "Atacado"],
      "Entretenimento": ["Lazer", "Streaming", "Cinema", "Shows", "Games"],
      "Compras": ["E-commerce", "Lojas", "Eletrônicos", "Casa e Decoração", "Casa & Decoração"],
      "Serviços profissionais": ["Contabilidade", "Jurídico", "Consultoria", "Freelancer"],
      "Comida e bebida": ["Restaurantes", "Lanches", "Bar", "Delivery", "iFood", "Rappi", "Uber Eats"],
      "Transporte": ["Uber", "99", "Combustível", "Estacionamento", "Pedágio", "Transporte público", "Bilhete Único", "Metro"],
      "Saúde e cuidados pessoais": ["Farmácia", "Plano de Saúde", "Exames", "Academia", "Barbearia", "Salão"]
    };

    const CATEGORY_ALIAS_INDEX = (() => {
      const idx = {};
      for (const [target, list] of Object.entries(CATEGORY_ALIASES)) {
        for (const alias of list) idx[alias.toLowerCase()] = target;
      }
      for (const c of CATEGORIES) idx[c.toLowerCase()] = c;
      return idx;
    })();

    function normalizeCategory(name) {
      if (!name) return "";
      const clean = String(name).trim().toLowerCase();
      return CATEGORY_ALIAS_INDEX[clean] || "";
    }

    // ==========================
    // Storage helpers
    // ==========================
    const LS_KEYS = {
      entradas: 'cg_entradas',
      saidas: 'cg_saidas',
      itens: 'cg_itens',
      contas: 'cg_contas',
      regras: 'cg_regras',
      orc: 'cg_orc',
      stores: 'cg_lojas'
    };
    const money = (n) => (n||0).toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
    const parseNum = (v) => {
      if (typeof v === 'number') return v;
      if (!v) return 0;
      let s = String(v).replace(/\s+/g,'').replace(/\./g,'').replace(',','.');
      return parseFloat(s) || 0;
    };
    const fmtDate = (d) => {
      // aceita Date, 'yyyy-mm-dd' ou 'dd/mm/yyyy'
      if (!d) return '';
      if (d instanceof Date) return d.toISOString().slice(0,10);
      const s = String(d);
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
      const m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if (m) return `${m[3]}-${m[2]}-${m[1]}`;
      return s;
    };

    function load(key, def){ try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(def)); } catch { return def; } }
    function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

    function loadEntradas(){ return load(LS_KEYS.entradas, []); }
    function saveEntradas(v){ save(LS_KEYS.entradas, v); }
    function loadSaidas(){ return load(LS_KEYS.saidas, []); }
    function saveSaidas(v){ save(LS_KEYS.saidas, v); }
    function loadItens(){ return load(LS_KEYS.itens, []); }
    function saveItens(v){ save(LS_KEYS.itens, v); }
    function loadContas(){ return load(LS_KEYS.contas, ["Nubank", "Banco Inter", "Mercado Pago"]); }
    function saveContas(v){ save(LS_KEYS.contas, v); }
    function loadRules(){ return load(LS_KEYS.regras, []); }
    function saveRules(v){ save(LS_KEYS.regras, v); }
    function loadOrc(){ return load(LS_KEYS.orc, []); }
    function saveOrc(v){ save(LS_KEYS.orc, v); }
    function loadStores(){ return load(LS_KEYS.stores, ["Uber","iFood","Mercado X"]); }
    function saveStores(v){ save(LS_KEYS.stores, v); }

    // Deduplicação por hash: data|valor|descrição
    function txHash(tx){
      return `${fmtDate(tx.data)}|${(+parseNum(tx.valor)).toFixed(2)}|${(tx.descricao||'').trim().toLowerCase()}`;
    }

    // ==========================
    // Inicialização
    // ==========================
    document.addEventListener('DOMContentLoaded', () => {
      // Tabs
      document.querySelectorAll('.tab-btn').forEach(btn=>{
        btn.addEventListener('click', () => switchTab(btn.dataset.tab));
      });

      // Preenche selects
      fillSelects();

      // Dashboard mês atual
      const m = new Date(); document.getElementById('dashMonth').value = `${m.getFullYear()}-${String(m.getMonth()+1).padStart(2,'0')}`;
      refreshDashboard();

      // PWA: registrar service worker
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').catch(()=>{});
      }

      // Importação: preencher select de categorias nas Regras
      const selRule = document.getElementById('ruleCategory');
      if (selRule) {
        selRule.innerHTML = '<option value="">Selecione…</option>' + CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join('');
      }
    });

    function switchTab(t){
      document.querySelectorAll('.tab').forEach(x=>x.style.display='none');
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      const el = document.getElementById(t);
      if (el) el.style.display = t === 'dashboard' ? '' : 'block';
      document.querySelector(`.tab-btn[data-tab="${t}"]`)?.classList.add('active');
      if (['entradas','saidas','itens','transferencias','orcamento','importacao','config','dashboard'].includes(t)) fillSelects();
      if (t === 'dashboard') refreshDashboard();
      if (t === 'importacao') { renderRules(); }
      if (t === 'orcamento') { renderBudget(); }
      if (t === 'entradas') { renderEntradas(); }
      if (t === 'saidas') { renderSaidas(); }
      if (t === 'itens') { renderItens(); }
      if (t === 'transferencias') { renderTransfers(); }
    }

    function fillSelects(){
      const contas = loadContas();
      const cats = CATEGORIES;
      // Dashboard
      fillOptions('dashAccount', ['Todas', ...contas]);
      // Entradas
      fillOptions('inAcc', contas); fillOptions('inCat', cats);
      // Saídas
      fillOptions('outAcc', contas); fillOptions('outCat', cats);
      // Itens
      fillOptions('itemCat', cats);
      // Transferências
      fillOptions('trFrom', contas); fillOptions('trTo', contas);
      // Importação
      fillOptions('impConta', contas);
      // Orçamento
      fillOptions('budCat', cats);
    }

    function fillOptions(id, list){
      const el = document.getElementById(id); if (!el) return;
      el.innerHTML = (list||[]).map(v => `<option value="${v}">${v}</option>`).join('');
    }

    // ==========================
    // Dashboard e relatórios
    // ==========================
    function refreshDashboard(){
      const month = document.getElementById('dashMonth').value || '';
      const acc = document.getElementById('dashAccount').value || 'Todas';
      const [y,m] = month.split('-').map(x=>parseInt(x||'0',10));

      const ins = loadEntradas().filter(x => matchYM(x.data, y, m) && matchAcc(x.conta, acc));
      const outs = loadSaidas().filter(x => matchYM(x.data, y, m) && matchAcc(x.conta, acc));
      const items = loadItens().filter(x => matchYM(x.data, y, m));

      const sumIn = ins.reduce((s,x)=>s+parseNum(x.valor),0);
      const sumOut = outs.reduce((s,x)=>s+parseNum(x.valor),0);
      document.getElementById('kpiIn').textContent = money(sumIn);
      document.getElementById('kpiOut').textContent = money(sumOut);
      document.getElementById('kpiBal').textContent = money(sumIn - sumOut);
      document.getElementById('kpiItems').textContent = items.length;

      // Relatório por categoria (saídas)
      const perCat = {};
      for (const s of outs) {
        const c = s.categoria || 'Sem categoria';
        perCat[c] = (perCat[c] || 0) + parseNum(s.valor);
      }
      const orcs = loadOrc();
      const html = Object.entries(perCat).sort((a,b)=>b[1]-a[1]).map(([cat, val])=>{
        const orc = orcs.find(o=>o.categoria===cat);
        const warn = orc && val > parseNum(orc.valor);
        return `<div class="row" style="justify-content:space-between;border-bottom:1px solid var(--border);padding:8px 0">
          <div><span class="tag">${cat}</span></div>
          <div>${money(val)} ${orc? `<span class="pill ${warn?'bad':'warn'}" style="margin-left:8px;">Orçado: ${money(orc.valor)}</span>`:''}</div>
        </div>`;
      }).join('') || '<div class="muted">Sem gastos no período.</div>';
      document.getElementById('reportCat').innerHTML = html;
    }

    function matchYM(d, y, m){
      if (!d || !y || !m) return true;
      const s = fmtDate(d);
      return +s.slice(0,4)===y && +s.slice(5,7)===m;
    }
    function matchAcc(c, a){ return a==='Todas' || c===a; }

    // ==========================
    // CRUD Entradas/Saídas/Itens/Transferências
    // ==========================
    function addEntrada(){
      const tx = {
        data: fmtDate(document.getElementById('inDate').value),
        descricao: document.getElementById('inDesc').value.trim(),
        valor: parseNum(document.getElementById('inVal').value),
        conta: document.getElementById('inAcc').value,
        categoria: normalizeCategory(document.getElementById('inCat').value),
        loja: document.getElementById('inStore').value.trim()
      };
      if (!tx.data || !tx.descricao || !tx.valor) return alert('Preencha data, descrição e valor');
      const arr = loadEntradas();
      arr.push(tx); saveEntradas(arr); renderEntradas(); refreshDashboard(); clearEntradaForm();
    }
    function clearEntradaForm(){ ['inDate','inDesc','inVal','inStore'].forEach(id=>document.getElementById(id).value=''); }

    function renderEntradas(){
      const tb = document.querySelector('#tblIn tbody'); const arr = loadEntradas();
      tb.innerHTML = arr.map((x,i)=>`<tr>
        <td>${fmtDate(x.data)}</td><td>${x.descricao}</td><td>${money(x.valor)}</td>
        <td>${x.conta||''}</td><td>${x.categoria||''}</td><td>${x.loja||''}</td>
        <td><button class="btn alt" onclick="delEntrada(${i})">Excluir</button></td>
      </tr>`).join('');
    }
    function delEntrada(i){ const arr = loadEntradas(); arr.splice(i,1); saveEntradas(arr); renderEntradas(); refreshDashboard(); }

    function addSaida(){
      const tx = {
        data: fmtDate(document.getElementById('outDate').value),
        descricao: document.getElementById('outDesc').value.trim(),
        valor: parseNum(document.getElementById('outVal').value),
        conta: document.getElementById('outAcc').value,
        categoria: normalizeCategory(document.getElementById('outCat').value),
        loja: document.getElementById('outStore').value.trim()
      };
      if (!tx.data || !tx.descricao || !tx.valor) return alert('Preencha data, descrição e valor');
      const arr = loadSaidas();
      arr.push(tx); saveSaidas(arr); renderSaidas(); refreshDashboard(); clearSaidaForm();
    }
    function clearSaidaForm(){ ['outDate','outDesc','outVal','outStore'].forEach(id=>document.getElementById(id).value=''); }

    function renderSaidas(){
      const tb = document.querySelector('#tblOut tbody'); const arr = loadSaidas();
      tb.innerHTML = arr.map((x,i)=>`<tr>
        <td>${fmtDate(x.data)}</td><td>${x.descricao}</td><td>${money(x.valor)}</td>
        <td>${x.conta||''}</td><td>${x.categoria||''}</td><td>${x.loja||''}</td>
        <td><button class="btn alt" onclick="delSaida(${i})">Excluir</button></td>
      </tr>`).join('');
    }
    function delSaida(i){ const arr = loadSaidas(); arr.splice(i,1); saveSaidas(arr); renderSaidas(); refreshDashboard(); }

    function addItem(){
      const it = {
        data: fmtDate(document.getElementById('itemDate').value),
        descricao: document.getElementById('itemDesc').value.trim(),
        qtd: parseInt(document.getElementById('itemQty').value||'1',10),
        preco: parseNum(document.getElementById('itemPrice').value),
        categoria: normalizeCategory(document.getElementById('itemCat').value),
        loja: document.getElementById('itemStore').value.trim()
      };
      if (!it.data || !it.descricao || !it.preco) return alert('Preencha data, descrição e preço');
      const arr = loadItens(); arr.push(it); saveItens(arr); renderItens(); refreshDashboard(); clearItemForm();
    }
    function clearItemForm(){ ['itemDate','itemDesc','itemQty','itemPrice','itemStore'].forEach(id=>document.getElementById(id).value=''); }
    function renderItens(){
      const tb = document.querySelector('#tblItems tbody'); const arr = loadItens();
      tb.innerHTML = arr.map((x,i)=> {
        const total = (x.qtd||0) * parseNum(x.preco||0);
        return `<tr>
          <td>${fmtDate(x.data)}</td><td>${x.descricao}</td><td>${x.qtd||1}</td>
          <td>${money(x.preco)}</td><td>${money(total)}</td>
          <td>${x.categoria||''}</td><td>${x.loja||''}</td>
          <td><button class="btn alt" onclick="delItem(${i})">Excluir</button></td>
        </tr>`;
      }).join('');
    }
    function delItem(i){ const arr = loadItens(); arr.splice(i,1); saveItens(arr); renderItens(); refreshDashboard(); }

    function addTransfer(){
      const tx = {
        data: fmtDate(document.getElementById('trDate').value),
        descricao: document.getElementById('trDesc').value.trim(),
        valor: parseNum(document.getElementById('trVal').value),
        from: document.getElementById('trFrom').value,
        to: document.getElementById('trTo').value
      };
      if (!tx.data || !tx.valor || !tx.from || !tx.to) return alert('Preencha data, valor, de e para');
      const ins = loadEntradas(); const outs = loadSaidas();
      outs.push({ data: tx.data, descricao: tx.descricao || `Transf p/ ${tx.to}`, valor: tx.valor, conta: tx.from, categoria: "Transferência", loja: ""});
      ins.push({ data: tx.data, descricao: tx.descricao || `Transf de ${tx.from}`, valor: tx.valor, conta: tx.to, categoria: "Transferência", loja: ""});
      saveSaidas(outs); saveEntradas(ins); renderTransfers(); refreshDashboard();
      ['trDate','trDesc','trVal'].forEach(id=>document.getElementById(id).value='');
    }
    function renderTransfers(){
      const tb = document.querySelector('#tblTr tbody'); const ins = loadEntradas(); const outs = loadSaidas();
      // monta pares simples por descrição
      const trs = [];
      for (const o of outs.filter(x=>x.categoria==='Transferência')){
        const i = ins.find(x=>x.categoria==='Transferência' && fmtDate(x.data)===fmtDate(o.data) && parseNum(x.valor)===parseNum(o.valor));
        trs.push({data:o.data, descricao:o.descricao, valor:o.valor, from:o.conta, to:i?.conta||''});
      }
      tb.innerHTML = trs.map((t,idx)=>`<tr>
        <td>${fmtDate(t.data)}</td><td>${t.descricao||''}</td><td>${money(t.valor)}</td><td>${t.from}</td><td>${t.to}</td>
        <td><button class="btn alt" onclick="delTransfer(${idx})">Excluir</button></td>
      </tr>`).join('');
    }
    function delTransfer(i){
      // remoção simplificada: não implementamos ligação direta; o usuário pode remover manualmente nas abas
      alert('Para remover uma transferência, exclua as linhas correspondentes em Entradas e Saídas.');
    }

    // ==========================
    // Orçamento
    // ==========================
    function addBudget(){
      const cat = normalizeCategory(document.getElementById('budCat').value);
      const val = parseNum(document.getElementById('budVal').value);
      if (!cat || !val) return alert('Selecione categoria e valor.');
      const arr = loadOrc();
      const idx = arr.findIndex(x=>x.categoria===cat);
      if (idx>=0) arr[idx].valor = val; else arr.push({categoria:cat, valor:val});
      saveOrc(arr); renderBudget();
      document.getElementById('budVal').value = '';
    }
    function renderBudget(){
      const arr = loadOrc();
      const tb = document.querySelector('#tblBudget tbody');
      tb.innerHTML = arr.map((x,i)=>`<tr><td>${x.categoria}</td><td>${money(x.valor)}</td><td><button class="btn alt" onclick="delBudget(${i})">Excluir</button></td></tr>`).join('');
    }
    function delBudget(i){ const arr = loadOrc(); arr.splice(i,1); saveOrc(arr); renderBudget(); }

    // ==========================
    // Importação (CSV/OFX) + Regras
    // ==========================
    let parsedRows = []; // linhas brutas após parse
    let csvHeaders = []; // cabeçalhos do CSV
    let mapped = [];     // linhas mapeadas p/ formato interno

    function handleImport(){
      const file = document.getElementById('impFile').files[0];
      if (!file) return alert('Selecione um arquivo');
      const name = file.name.toLowerCase();
      if (name.endsWith('.ofx')) {
        parseOFX(file);
      } else {
        parseCSVFile(file);
      }
    }

    function parseCSVFile(file){
      const enc = document.getElementById('impEnc').value || 'UTF-8';
      const sepSel = document.getElementById('impSep').value;
      const sep = sepSel === 'tab' ? '\t' : sepSel;

      const fr = new FileReader();
      fr.onload = () => {
        let text = fr.result;
        if (typeof text !== 'string') text = new TextDecoder(enc).decode(text);
        const lines = text.replace(/\r/g,'').split('\n').filter(l=>l.trim().length>0);
        csvHeaders = splitCSV(lines[0], sep);
        parsedRows = lines.slice(1).map(l => splitCSV(l, sep));
        suggestMappingByOrigin(csvHeaders);
        buildPreview();
      };
      if (enc === 'UTF-8') fr.readAsText(file);
      else fr.readAsArrayBuffer(file);
    }

    function splitCSV(line, sep){
      const s = sep;
      // simples: suporta campos entre aspas
      const out = [];
      let cur = '', inside = false;
      for (let i=0;i<line.length;i++){
        const ch = line[i];
        if (ch === '"'){ inside = !inside; continue; }
        if (ch === s && !inside){ out.push(cur); cur=''; continue; }
        cur += ch;
      }
      out.push(cur);
      return out.map(x=>x.trim());
    }

    function suggestMappingByOrigin(headers){
      const h = headers.map(x=>x.toLowerCase());
      const setSel = (id, names) => {
        const el = document.getElementById(id);
        el.innerHTML = headers.map((x,i)=>`<option value="${i}">${x}</option>`).join('');
        // tenta achar
        for (const n of names){
          const idx = h.findIndex(y => y.includes(n));
          if (idx>=0){ el.value = idx; return; }
        }
        el.value = '';
      };

      const origem = document.getElementById('impOrigem').value;

      if (origem==='nubank' || (origem==='auto' && h.includes('title') && h.includes('amount'))) {
        // Nubank CSV: columns: title, amount, category, time
        setSel('mapDate', ['time','date','data']);
        setSel('mapDesc', ['title','descricao','descrição','description']);
        setSel('mapVal', ['amount','valor','value']);
        setSel('mapType', ['type','tipo','c/d']);
        return;
      }

      if (origem==='mercadopago' || (origem==='auto' && h.some(x=>x.includes('mercado pago') || x.includes('mercadopago')))) {
        setSel('mapDate', ['data','date','fecha']);
        setSel('mapDesc', ['descricao','descrição','description','detalle','detalhe','concepto']);
        setSel('mapVal', ['valor','value','importe','monto']);
        setSel('mapType', ['tipo','type','c/d']);
        return;
      }

      if (origem==='inter' || (origem==='auto' && h.includes('historico') && h.some(x=>x.includes('valor') || x.includes('valor (r$)')))){
        // Banco Inter CSV comum: Data, Historico, Valor (R$), Tipo (D/C)...
        setSel('mapDate', ['data','date']);
        setSel('mapDesc', ['historico','histórico','descricao','descrição']);
        setSel('mapVal', ['valor','valor (r$)','amount','value']);
        setSel('mapType', ['tipo','d/c','c/d']);
        return;
      }

      // Genérico
      setSel('mapDate', ['data','date']);
      setSel('mapDesc', ['descricao','descrição','description','histórico','historico','title']);
      setSel('mapVal', ['valor','value','amount','importe','monto']);
      setSel('mapType', ['tipo','type','c/d']);
    }

    function applyMapping(){
      mapped = [];
      const iDate = parseInt(document.getElementById('mapDate').value,10);
      const iDesc = parseInt(document.getElementById('mapDesc').value,10);
      const iVal  = parseInt(document.getElementById('mapVal').value,10);
      const iType = document.getElementById('mapType').value === '' ? null : parseInt(document.getElementById('mapType').value,10);

      if (Number.isNaN(iDate) || Number.isNaN(iDesc) || Number.isNaN(iVal)){
        alert('Mapeie Data, Descrição e Valor.'); return;
      }

      for (const row of parsedRows){
        const rawDate = row[iDate];
        const rawDesc = row[iDesc];
        const rawVal  = row[iVal];
        const rawType = iType!=null ? (row[iType]||'') : '';

        let valor = parseNum(rawVal);
        // se tiver coluna tipo, interpreta C/D
        let tipo = '';
        const t = String(rawType||'').toUpperCase();
        if (t.includes('D')) tipo='D';
        else if (t.includes('C')) tipo='C';
        else if (valor<0) tipo='D';
        else tipo='C';

        const tx = {
          data: fmtDate(guessDate(rawDate)),
          descricao: rawDesc || '',
          valor: Math.abs(valor),
          tipo, // C=Crédito(Entrada), D=Débito(Saída)
          conta: document.getElementById('impConta').value,
          categoriaCsv: '', // se o CSV trouxer categoria, pode ser extraída se você quiser extender
          categoria: '',
          loja: ''
        };
        applyCategoryRulesOrAliases(tx);
        mapped.push(tx);
      }
      buildPreview();
    }

    function guessDate(s){
      const str = String(s).trim();
      // tenta dd/mm/yyyy
      let m = str.match(/^(\d{2})\/(\d{2})\/(\d{4})/);
      if (m) return `${m[3]}-${m[2]}-${m[1]}`;
      // yyyy-mm-dd
      m = str.match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (m) return `${m[1]}-${m[2]}-${m[3]}`;
      // yyyy-mm-ddTHH...
      m = str.match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (m) return `${m[1]}-${m[2]}-${m[3]}`;
      // fallback: hoje
      const d = new Date(); return d.toISOString().slice(0,10);
    }

    function parseOFX(file){
      const fr = new FileReader();
      fr.onload = () => {
        const text = fr.result;
        const txs = [];
        // parse simples de OFX (STMTTRN)
        const blocks = text.split('<STMTTRN>').slice(1);
        for (const b of blocks){
          const get = (tag) => {
            const m = b.match(new RegExp(`<${tag}>([^<\\r\\n]+)`,'i'));
            return m ? m[1].trim() : '';
          };
          const tipo = (get('TRNTYPE')||'').toUpperCase(); // DEBIT/CREDIT
          const dt = get('DTPOSTED'); // 20240901...
          const y = dt.slice(0,4), mo = dt.slice(4,6), da = dt.slice(6,8);
          const valor = parseNum(get('TRNAMT'));
          const desc = get('MEMO') || get('NAME') || '';
          const tx = {
            data: `${y}-${mo}-${da}`,
            descricao: desc,
            valor: Math.abs(valor),
            tipo: valor < 0 || tipo==='DEBIT' ? 'D' : 'C',
            conta: document.getElementById('impConta').value,
            categoria: '',
            loja: ''
          };
          applyCategoryRulesOrAliases(tx);
          txs.push(tx);
        }
        parsedRows = [];
        csvHeaders = [];
        mapped = txs;
        buildPreview();
      };
      fr.readAsText(file);
    }

    function buildPreview(){
      const box = document.getElementById('previewBox');
      if (!mapped.length){
        box.innerHTML = '<div class="muted" style="padding:8px">Sem dados para pré-visualizar.</div>'; return;
      }
      const rows = mapped.slice(0,200).map(x=>`<tr>
        <td>${fmtDate(x.data)}</td>
        <td>${x.descricao}</td>
        <td>${x.tipo==='D' ? '-' : ''}${money(x.valor)}</td>
        <td>${x.conta||''}</td>
        <td>${x.categoria||''}</td>
        <td>${x.loja||''}</td>
      </tr>`).join('');
      box.innerHTML = `<table>
        <thead><tr><th>Data</th><th>Descrição</th><th>Valor</th><th>Conta</th><th>Categoria</th><th>Loja</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>`;
    }

    function applyCategoryRulesOrAliases(tx){
      const rules = loadRules();
      const desc = (tx.descricao || '').toLowerCase();
      for (const r of rules) {
        if (r.contains && desc.includes(r.contains)) {
          tx.categoria = normalizeCategory(r.category || r.categoria || "");
          if (r.store) tx.loja = r.store;
          break;
        }
      }
      if (!tx.categoria && tx.categoriaCsv) {
        const norm = normalizeCategory(tx.categoriaCsv);
        if (norm) tx.categoria = norm;
      }
      return tx;
    }

    function confirmImport(){
      if (!mapped.length) return alert('Nada para importar.');
      const entradas = loadEntradas();
      const saidas = loadSaidas();
      const seen = new Set([
        ...entradas.map(txHash),
        ...saidas.map(txHash)
      ]);
      let addIn=0, addOut=0, dup=0;

      for (const x of mapped){
        const sign = x.tipo === 'D' ? -1 : 1;
        const tx = {
          data: fmtDate(x.data),
          descricao: x.descricao,
          valor: Math.abs(parseNum(x.valor)),
          conta: x.conta,
          categoria: x.categoria || '',
          loja: x.loja || ''
        };
        const h = txHash({ ...tx, valor: sign * tx.valor });
        if (seen.has(h)){ dup++; continue; }
        seen.add(h);
        if (sign<0){ saidas.push(tx); addOut++; } else { entradas.push(tx); addIn++; }
      }
      saveEntradas(entradas); saveSaidas(saidas);
      alert(`Importação concluída.\nEntradas: ${addIn}\nSaídas: ${addOut}\nDuplicados ignorados: ${dup}`);
      mapped = []; buildPreview();
      refreshDashboard(); renderEntradas(); renderSaidas();
    }

    // Regras
    function renderRules(){
      const rules = loadRules();
      const html = rules.map((r,i)=>`<div class="row" style="justify-content:space-between;border:1px solid var(--border);border-radius:8px;padding:8px">
        <div>
          <div><strong>Se contiver:</strong> ${r.contains}</div>
          <div class="muted">Categoria: ${r.category || r.categoria} ${r.store? `• Loja: ${r.store}`:''}</div>
        </div>
        <div><button class="btn alt" onclick="delRule(${i})">Excluir</button></div>
      </div>`).join('') || '<div class="muted">Nenhuma regra criada.</div>';
      document.getElementById('rulesList').innerHTML = html;
    }
    function addRule(){
      const text = document.getElementById('ruleText').value.trim();
      const catRaw = document.getElementById('ruleCategory').value;
      const store = document.getElementById('ruleStore').value.trim();
      if (!text) { alert('Informe um texto para a regra'); return; }
      const category = normalizeCategory(catRaw);
      if (!category) { alert('Selecione uma categoria válida'); return; }
      const rules = loadRules();
      rules.push({ contains: text.toLowerCase(), category, store });
      saveRules(rules); renderRules();
      document.getElementById('ruleText').value=''; document.getElementById('ruleStore').value=''; document.getElementById('ruleCategory').value='';
    }
    function delRule(i){ const rules = loadRules(); rules.splice(i,1); saveRules(rules); renderRules(); }

    // ==========================
    // Configurações (contas, lojas, backup)
    // ==========================
    function saveConfig(){
      const accs = (document.getElementById('cfgAccounts').value||'').split('\n').map(x=>x.split(';')).flat().map(x=>x.trim()).filter(Boolean);
      const stores = (document.getElementById('cfgStores').value||'').split('\n').map(x=>x.split(';')).flat().map(x=>x.trim()).filter(Boolean);
      if (accs.length) saveContas(accs);
      if (stores.length) saveStores(stores);
      fillSelects();
      alert('Configurações salvas.');
    }

    function downloadBackup(){
      const data = {
        entradas: loadEntradas(),
        saidas: loadSaidas(),
        itens: loadItens(),
        contas: loadContas(),
        regras: loadRules(),
        orc: loadOrc(),
        stores: loadStores()
      };
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'backup-controle-gastos.json';
      a.click();
    }

    function restoreBackup(){
      const f = document.getElementById('restoreFile').files[0];
      if (!f) return alert('Selecione o arquivo de backup.');
      const fr = new FileReader();
      fr.onload = () => {
        try {
          const data = JSON.parse(fr.result);
          if (data.entradas) saveEntradas(data.entradas);
          if (data.saidas) saveSaidas(data.saidas);
          if (data.itens) saveItens(data.itens);
          if (data.contas) saveContas(data.contas);
          if (data.regras) saveRules(data.regras);
          if (data.orc) saveOrc(data.orc);
          if (data.stores) saveStores(data.stores);
          fillSelects(); refreshDashboard(); renderEntradas(); renderSaidas(); renderItens(); renderBudget();
          alert('Backup restaurado.');
        } catch(e){ alert('Arquivo inválido.'); }
      };
      fr.readAsText(f);
    }

  </script>
</body>
</html>
